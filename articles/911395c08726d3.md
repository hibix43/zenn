---
title: "updateメソッドの使い道 〜AsyncNotifierで事前条件を検証する〜"
emoji: "⌛"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["flutter", "dart", "riverpod"]
published: false
---

契約プログラミングをご存知でしょうか？簡単に言うと契約プログラミングとは、メソッドの事前条件と事後条件を明示的に記述することで、メソッドの正しさを保証するプログラミング手法です。

例えば、サインイン処理を実行する前に未認証状態であることを確認する処理を書き、サインイン処理が成功した後に認証状態であることを確認する処理を書くことで、サインイン処理の正しさを保証することができます。

この記事ではRiverpodのAsyncNotifierに上記の検証を実装した際に私が遭遇した問題とその解決策を紹介します。

## 認証状態を管理するAsyncNotifier

まずは認証状態を管理するAsyncNotifierを実装します。

```dart
@riverpod
class Authenticator extends _$Authenticator {
  Future<SignInStatus> build() async {
    // CognitoやFirebaseなどの認証パッケージを使って認証状態を取得するイメージ
    final authDriver = await getAuthDriver();
    return await authDriver.fetchSignInStatus();
  }

  Future<void> signIn() async {
    // サインイン処理
  }
}
```

## 事前条件を検証する

```dart
Future<void> signIn() async {
  assert(state == SignInStatus.signedOut); // 事前条件を検証する
  // サインイン処理
  state = AsyncValue.loading();
  state = AsyncValue.guard(() async {
    final result = await authDriver.signIn();
    return switch (result) {
      SignInResult.success: AsyncValue.data(SignInStatus.signedIn);
      _ => AsyncValue.data(SignInStatus.signedOut);
    }
  });
  assert(state == SignInStatus.signedIn); // 事後条件を検証する
}
```

## 発生する問題

上記のように事前条件の検証は成功するときと失敗する時があります。何が原因なのでしょうか？

失敗する場合は、`state`が`AsyncValue.loading()`の状態で`assert`が実行されるためです。では、なぜ`state`が`AsyncValue.loading()`の状態になっているのでしょうか？

それは非同期であるbuildメソッドが完了していないまま、signInメソッドが実行されてしまうためです。

## 解決策

buildメソッドが完了するまでsignInメソッドを実行できないようにする必要があります。
言い換えれば、signInメソッド内でbuildメソッドが完了するまで待機する必要があります。
これを実現するために`update`メソッドを使いましょう。

updateメソッドでは引数に渡した処理をbuildメソッドが完了した後に実行してくれます。
そのため、signInの処理をupdateメソッドに渡す形に変更しましょう。

```dart
// 問題がある
Future<void> signIn() async {
  await update(() async {
    assert(state == SignInStatus.signedOut); // 事前条件を検証する
    // サインイン処理
    state = AsyncValue.loading();
    state = AsyncValue.guard(() async {
      final result = await authDriver.signIn();
      return switch (result) {
        SignInResult.success: AsyncValue.data(SignInStatus.signedIn);
        _ => AsyncValue.data(SignInStatus.signedOut);
      }
    });
    assert(state == SignInStatus.signedIn); // 事後条件を検証する
  });
}
```

```dart
// returnする形のコード
```

## なぜupdateメソッドを使うと問題が解決するのか？

updateメソッドはbuildメソッドが完了するまで処理を待機するため、buildメソッドが完了する前にsignInメソッドが実行されることはありません。
なぜそう言い切れるのでしょうか？それはupdateメソッドの実装を少しだけ覗いてみるとわかります。

```dart
then
```

thenが使用されています。thenはFutureの処理が完了した後に実行される処理を登録するメソッドです。
このことから、updateメソッドはbuildメソッドが完了するまで処理を待機することがわかります。

## Notifier では問題は発生しない

Notifierを使っている場合は、updateメソッドを使わなくても問題は発生しません。
理由は言うまでもないでしょう。

```dart
```

## まとめ

aaa
