---
title: "setState()ã«éåŒæœŸå‡¦ç†ã‚’æ¸¡ã—ã¦ã¯ã„ã‘ãªã„ç†ç”±"
emoji: "ğŸ™…â€â™‚ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["flutter"]
published: false
---

Flutterã®çŠ¶æ…‹ç®¡ç†ã«ã¯æ§˜ã€…ãªæ–¹æ³•ãŒã‚ã‚Šã¾ã™ãŒã€ãã®ä¸­ã§ã‚‚ä¸€ç•ªç°¡å˜ãªã®ãŒ`setState()`ã§ã™ã‚ˆã­ã€‚ã—ã‹ã—ã€`setState`ã§éåŒæœŸå‡¦ç†ã‚’è¡Œã†ã“ã¨ã¯ã§ããšã€`assert`ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

ãªãœã€`assert`ã‚’ä½¿ç”¨ã—ã¦éåŒæœŸå‡¦ç†ã‚’è¡Œã†ã“ã¨ã‚’ç¦æ­¢ã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ä»Šå›ã¯ç„¡ç†ã‚„ã‚ŠéåŒæœŸå‡¦ç†ã‚’è¡Œã†ã¨ã©ã†ãªã‚‹ã®ã‹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

## ç’°å¢ƒ

- Flutter 3.7.12
- Dart 2.19.6

## setState()ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã®ãã„ã¦ã¿ã‚‹

`setState()`ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã¿ã‚‹ã¨`assert`ã§éåŒæœŸå‡¦ç†ã‚’è¡Œã†ã“ã¨ã‚’ç¦æ­¢ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚`_element!.markNeedsBuild()`ã¯çŠ¶æ…‹ãŒå¤‰åŒ–ã—ãŸã“ã¨ã‚’ä¼ãˆã€ç”»é¢ã‚’æ›´æ–°ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹å‡¦ç†ã§ã™ã€‚

```dart
@protected
void setState(VoidCallback fn) {
  // éåŒæœŸå‡¦ç†ã¨ã¯é–¢ä¿‚ãªã„ assert ã¯çœç•¥
  final Object? result = fn() as dynamic;
  assert(() {
    if (result is Future) {
      throw FlutterError.fromParts(<DiagnosticsNode>[
        ErrorSummary('setState() callback argument returned a Future.'),
        ErrorDescription(
          'The setState() method on $this was called with a closure or method that '
          'returned a Future. Maybe it is marked as "async".',
        ),
        ErrorHint(
          'Instead of performing asynchronous work inside a call to setState(), first '
          'execute the work (without updating the widget state), and then synchronously '
          'update the state inside a call to setState().',
        ),
      ]);
    }
    return true;
  }());
  _element!.markNeedsBuild(); // ç”»é¢ã‚’æ›´æ–°ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹
}
```

## ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¦ã¿ã‚‹

`setState()`ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«éåŒæœŸå‡¦ç†ã‚’æ¸¡ã™ã¨ã‚¨ãƒ©ãƒ¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
ï¼ˆ`_MyHomePageState#ae179`ã¯`setState()`ã‚’å‘¼ã³å‡ºã—ãŸ`State`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰

:::message
ç™»å ´ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯Flutterã®å…¬å¼ã‚µãƒ³ãƒ—ãƒ«ã§ã‚ã‚‹ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¢ãƒ—ãƒªã‚’æ”¹å¤‰ã—ãŸã‚‚ã®ã§ã™ã€‚
:::

```dart
void _incrementCounter() {
  setState(() async {
    await Future.delayed(Duration(seconds: 1));
    _counter++;
  });
}
```

>setState() callback argument returned a Future.
>
>The setState() method on _MyHomePageState#ae179 was called with a closure or method that returned a Future. Maybe it is marked as "asyncâ€.
>
>Instead of performing asynchronous work inside a call to setState(), first execute the work (without updating the widget state), and then synchronously update the state inside a call to setState()

ã–ã£ãã‚Šã¨ã—ãŸè¨³ã™ã¨ã€Œ`setState()`ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒ`Future`ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚éåŒæœŸå‡¦ç†ã‚’è¡Œã†å ´åˆã¯ã€`setState()`ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§ã¯éåŒæœŸå‡¦ç†ã‚’è¡Œã‚ãšã€éåŒæœŸå‡¦ç†ã‚’è¡Œã£ãŸå¾Œã«`setState()`ã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„ã€ã¨ã„ã£ãŸæ„Ÿã˜ã§ã—ã‚‡ã†ã‹ã€‚

å®Ÿéš›ã€`setState()`ã®å‰ã«éåŒæœŸå‡¦ç†ã‚’è¡Œã„ã€ãã®å¾Œã«`setState()`ã‚’å‘¼ã³å‡ºã™ã¨ã‚¨ãƒ©ãƒ¼ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚

```dart
void _incrementCounter() async {
  await Future.delayed(Duration(seconds: 1));
  setState(() {
    _counter++;
  });
}
```

## ç„¡ç†ã‚„ã‚ŠéåŒæœŸã®å‡¦ç†ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

`setState()`ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«éåŒæœŸã®å‡¦ç†ã‚’è¡Œã†ã“ã¨ã‚’ç¦æ­¢ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã£ãŸã®ã§ã€ç„¡ç†ã‚„ã‚ŠéåŒæœŸå‡¦ç†ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã™ã€‚

```dart
@protected
void setState(VoidCallback fn) {
  final Object? result = fn() as dynamic;
  // assert ã‚’å‰Šé™¤
  _element!.markNeedsBuild();
}
```

`assert`ã‚’å‰Šé™¤ã™ã‚‹ã¨ã€`setState()`ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦éåŒæœŸå‡¦ç†ã‚’æ¸¡ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚

```dart
void _incrementCounter() {
  setState(() async {
    await Future.delayed(Duration(seconds: 1));
    _counter++;
  });
}
```
